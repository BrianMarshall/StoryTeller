function StringBuilder(){var e=[];this.append=function(t){if(t){e.push(t)}};this.getValue=function(){return e.join("")}}function stringFormat(e,t){return e.replace(/{(\d+)}/g,function(e,n){return t[n]})}function BooleanVariable(e){var t=Boolean(e);this.set=function(e){t=Boolean(e)};this.get=function(){return t};this.size=function(){return 1};this.toInt16Array=function(){if(t){return[1]}else{return[0]}};this.fromInt16Array=function(e){t=(e[0]&1)==1}}function IntegerVariable(e,t,n,r){function f(n){n=Math.floor(n);if(isNaN(n)){n=0}if(n<e){if(r){n=((n-i)%u+u)%u+e}else{n=i}}if(n>t){if(r){n=(n-i)%u+e}else{n=s}}return n}if(t<e){throw new Error("max cannot be less than min")}var i=e;var s=t;var o=r;var u=t-e+1;var a=Math.ceil(Math.log(u)/Math.log(2));var l=f(n);this.set=function(e){l=f(e)};this.get=function(){return l};this.size=function(){return a};this.toInt16Array=function(){var e=[];var t=Math.ceil(a/16);var n=l-i;for(var r=0;r<t;r++){e[r]=n%65536;n=Math.floor(n/65536)}return e};this.fromInt16Array=function(e){var t=0;for(var n=e.length-1;n>=0;n--){t*=65536;t+=e[n]}l=f(t+i)}}function NumberVariable(e){function n(e){if(e==Number.POSITIVE_INFINITY){return{sign:0,biasedExponent:2047,mantissa:0}}if(e==Number.NEGATIVE_INFINITY){return{sign:1,biasedExponent:2047,mantissa:0}}if(isNaN(e)){return{sign:1,biasedExponent:2047,mantissa:0xfffffffffffff}}if(e==0){return{sign:0,biasedExponent:0,mantissa:0}}var t={};t.sign=e<0?1:0;var n=Math.abs(e);var r=Math.floor(Math.log(n)/Math.log(2));t.biasedExponent=r+1023;if(t.biasedExponent==0){var i=Math.pow(2,-1022);t.mantissa=n/i*4503599627370496}else{var i=Math.pow(2,r);var s=n/i;t.mantissa=(s-1)*4503599627370496}return t}function r(e){if(e.biasedExponent==2047){if(e.mantissa==0){if(e.sign==0){return Number.POSITIVE_INFINITY}else{return Number.NEGATIVE_INFINITY}}else{return NaN}}var t;var n;if(e.biasedExponent==0){t=e.mantissa/4503599627370496;n=Math.pow(2,-1022)}else{t=1+e.mantissa/4503599627370496;var r=e.biasedExponent-1023;n=Math.pow(2,r)}var i=t*n;return e.sign==1?-i:i}var t=Number(e);this.set=function(e){t=Number(e)};this.get=function(){return t};this.size=function(){return 64};this.toInt16Array=function(){var e=n(t);var r=e.mantissa;var i=[];for(var s=0;s<3;s++){i[s]=r%65536;r=Math.floor(r/65536)}i[3]=e.sign<<15|e.biasedExponent<<4|r;return i};this.fromInt16Array=function(e){var n={};var i=e[3]&15;for(var s=2;s>=0;s--){i*=65536;i+=e[s]}n.mantissa=i;n.biasedExponent=e[3]>>4&2047;n.sign=e[3]>>15;t=r(n)}}function RandomNumberGenerator(){var e=new IntegerVariable(0,Math.pow(2,32)-1,Math.floor(Math.random()*Math.pow(2,32)),false);var t=1013904223;var n=Math.pow(2,32);var r=1664525;var i=Math.pow(2,52);this.getByte=function(){var i=e.get();i=(r*i+t)%n;e.set(i);return(i&1044480)>>12};this.getDouble=function(){var e=0;for(var t=0;t<6;t++){e*=256;e+=this.getByte()}e*=16;e+=this.getByte()>>4;return e/i};this.getBoolean=function(e){return this.getDouble()<e};this.getNumber=function(e,t){return this.getDouble()*(t-e)+e};this.getInteger=function(e,t){return Math.floor(this.getNumber(e,t))};this.size=function(){return e.size()};this.toInt16Array=function(){return e.toInt16Array()};this.fromInt16Array=function(t){e.fromInt16Array(t)}}function State(e,t){function i(e){var t=new Base64.Reader(e);for(var r=0;r<n.length;r++){var i=n[r];var s=t.readInt16Array(i.size());i.fromInt16Array(s)}}function s(){return window.location.hash.replace(/^#/,"")}function u(){var e=s();if(e!=o){o=e;i(o);r()}}var n=e;var r=t;this.toBase64=function(){var e=new Base64.Builder;for(var t=0;t<n.length;t++){var r=n[t];e.addInt16Array(r.toInt16Array(),r.size())}return e.chars()};this.fromBase64=i;var o=s();if(o.length==0){o=this.toBase64();window.location.hash=o}else{i(o)}var a=window.setInterval(u,100)}function Compiler(e,t){function f(){var e;this.get=function(){return e};this.set=function(t){e=t}}function p(){var e=[];this.addLine=function(t){e.push(t)};this.execute=function(){var t=new StringBuilder;for(var n=0;n<e.length;n++){var r=e[n];try{t.append(r.execute())}catch(i){if(r.source){throw new Error(stringFormat("Unable to execute statement '{0}':\n{1}",[r.source,i.message]))}}}return t.getValue()}}function d(e){function r(e){n={condition:e,block:new p};t.push(n)}var t=[];var n;r(e);this.addCondition=function(e){if(n.condition==null){throw new Error("Unreachable 'else' clause")}r(e)};this.addLine=function(e){n.block.addLine(e)};this.execute=function(){for(var e=0;e<t.length;e++){var n=t[e];if(n.condition==null||n.condition.evaluate().value){return n.block.execute()}}}}function v(e,t){var n=new p;var r=[n];for(var i=0;i<t.length;i++){var s=t[i];r.push({evaluate:function(){return s.evaluate().value},assign:s.assign.bind(s)})}this.addLine=function(e){n.addLine(e)};this.execute=function(){return e.apply(null,r)}}function m(e){throw new Error("Expression cannot be assigned to")}function g(e){return{value:e,output:true}}function y(e){return{value:e,output:false}}function b(e){return{evaluate:function(){return g(e)},assign:function(e){throw new Error("Attempt to assign to literal")}}}function w(e){return{evaluate:function(){return g(e.get())},assign:function(t){e.set(t);return y(e.get())}}}function E(e,t){return{evaluate:function(){return e.assign(t.evaluate().value)},assign:m}}function S(e,t){return{evaluate:function(){return g(e.evaluate().value==t.evaluate().value)},assign:m}}function x(e,t){return{evaluate:function(){return g(e.evaluate().value!=t.evaluate().value)},assign:m}}function T(e,t){return{evaluate:function(){return g(e.evaluate().value<t.evaluate().value)},assign:m}}function N(e,t){return{evaluate:function(){return g(e.evaluate().value<=t.evaluate().value)},assign:m}}function C(e,t){return{evaluate:function(){return g(e.evaluate().value>t.evaluate().value)},assign:m}}function k(e,t){return{evaluate:function(){return g(e.evaluate().value>=t.evaluate().value)},assign:m}}function L(e,t){return{evaluate:function(){return g(e.evaluate().value+t.evaluate().value)},assign:m}}function A(e,t){return{evaluate:function(){return g(e.evaluate().value-t.evaluate().value)},assign:m}}function O(e,t){return{evaluate:function(){return g(e.evaluate().value*t.evaluate().value)},assign:m}}function M(e,t){return{evaluate:function(){return g(e.evaluate().value/t.evaluate().value)},assign:m}}function _(e,t){return{evaluate:function(){return g(e.evaluate().value%t.evaluate().value)},assign:m}}function D(e,t){return{evaluate:function(){return g(e.evaluate().value&&t.evaluate().value)},assign:m}}function P(e,t){return{evaluate:function(){return g(e.evaluate().value||t.evaluate().value)},assign:m}}function H(e){return{evaluate:function(){return g(!e.evaluate().value)},assign:m}}function B(e){return{evaluate:function(){return g(-e.evaluate().value)},assign:m}}function j(e,t){return{evaluate:function(){evaluatedParameters=[];for(var n=0;n<t.length;n++){evaluatedParameters.push(t[n].evaluate().value)}return g(e.apply(null,evaluatedParameters))},assign:m}}function F(e,t){return{block:new v(e,t),evaluate:function(){throw new Error("Block functions cannot be evaluated in a statement.")},assign:m}}function pt(){var e=[];this.addToken=function(t){switch(t.tokenType){case l.operator:var n=e.pop();var r=e.pop();e.push(t.expression(r,n));break;case l.unaryOperator:var i=e.pop();e.push(t.expression(i));break;case l.func:var s=[];var o;while(o=e.pop()){s.push(o)}e.push(j(t.operation,s.reverse()));break;case l.blockFunc:var s=[];var o;while(o=e.pop()){s.push(o)}e.push(F(t.operation,s.reverse()));break;case l.literal:e.push(b(t.value));break;case l.variable:e.push(w(t.value));break;case l.marker:e.push(null)}};this.getExpression=function(){if(e.length==0){throw new Error("Empty expression")}if(e.length>1){throw new Error("Incomplete expression")}return e.pop()}}function dt(){function n(t){if(e.length==0)return false;var n=e[e.length-1].tokenType;for(var r=0;r<t.length;r++){if(n==t[r])return true}return false}function r(t){if(e.length==0)return false;var n=e[e.length-1];return n.tokenType==l.unaryOperator||n.tokenType==l.operator&&n.precedence>=t}var e=[];var t=new pt;this.addToken=function(i){switch(i.tokenType){case l.leftBracket:e.push(i);break;case l.rightBracket:while(!n([l.leftBracket])){t.addToken(e.pop())}e.pop();if(n([l.func,l.blockFunc])){t.addToken(e.pop())}break;case l.separator:while(!n([l.leftBracket])){t.addToken(e.pop())}break;case l.operator:while(r(i.precedence)){t.addToken(e.pop())}e.push(i);break;case l.unaryOperator:e.push(i);break;case l.func:case l.blockFunc:e.push(i);t.addToken(I);break;default:t.addToken(i)}};this.getExpression=function(){while(e.length>0){t.addToken(e.pop())}return t.getExpression()}}function vt(e){return{execute:function(){return e}}}function mt(e,t){return{execute:function(){var t=e.evaluate();if(t.output){return t.value}},source:t}}var n=/((\[\[)|([^[]))+|(\[(("(([\\]")|[^"])*")|([^\]]))*\])/g;var r=/^\[(("((\\")|[^"])*")|([^\]]))*\]$/;var i=/[^\$_a-zA-Z0-9\s"]|([0-9]*\.[0-9]+)|([0-9]+)|(\$[_a-zA-Z0-9]+)|([_a-zA-Z][_a-zA-Z0-9]*)|("((\\")|[^"])*")/g;var s=/^[_a-zA-Z][_a-zA-Z0-9]*$/;var o=/^\$[_a-zA-Z0-9]+$/;var u=/^([0-9]*\.[0-9])|([0-9]+)$/;var a=/^"((\\")|[^"])*"$/;var l={leftBracket:1,rightBracket:2,separator:5,func:6,blockFunc:7,operator:8,unaryOperator:9,variable:10,literal:11,marker:12};var c={incomplete:1,complete:2,func:3};var h=[];h[l.leftBracket]=c.start;h[l.rightBracket]=c.complete;h[l.separator]=c.start;h[l.func]=c.func;h[l.operator]=c.incomplete;h[l.unaryOperator]=c.incomplete;h[l.variable]=c.complete;h[l.literal]=c.complete;var I={tokenType:l.marker};var q={tokenType:l.leftBracket};var R={tokenType:l.rightBracket};var U={tokenType:l.separator};var z={tokenType:l.operator,precedence:0,expression:E};var W={tokenType:l.operator,precedence:1,expression:D};var X={tokenType:l.operator,precedence:1,expression:P};var V={tokenType:l.operator,precedence:2,expression:S};var $={tokenType:l.operator,precedence:2,expression:x};var J={tokenType:l.operator,precedence:2,expression:T};var K={tokenType:l.operator,precedence:2,expression:N};var Q={tokenType:l.operator,precedence:2,expression:C};var G={tokenType:l.operator,precedence:2,expression:k};var Y={tokenType:l.operator,precedence:3,expression:L};var Z={tokenType:l.operator,precedence:3,expression:A};var et={tokenType:l.operator,precedence:4,expression:O};var tt={tokenType:l.operator,precedence:4,expression:M};var nt={tokenType:l.operator,precedence:4,expression:_};var rt={tokenType:l.unaryOperator,expression:H};var it={tokenType:l.unaryOperator,expression:B};var st=[];st[c.start]={"(":q,")":R,"-":it,not:rt,"true":{tokenType:l.literal,value:true},"false":{tokenType:l.literal,value:false}};st[c.complete]={")":R,",":U,"=":z,equal:V,notEqual:$,lessThan:J,lessThanOrEqual:K,greaterThan:Q,greaterThanOrEqual:G,"+":Y,"-":Z,"*":et,"/":tt,"%":nt,and:W,or:X};st[c.incomplete]=st[c.start];st[c.func]={"(":q};var ot={"if":true,"else":true,end:true,equal:true,notEqual:true,lessThan:true,lessThanOrEqual:true,greaterThan:true,greaterThanOrEqual:true,and:true,or:true,"true":true,"false":true};var ut={};if(t&&t.length){for(var at=0;at<t.length;at++){var ft=t[at];var lt=ft.name;if(ut[lt]){throw Error(stringFormat("Duplicate function name '{0}'",[lt]))}if(!s.test(lt)||ot[lt]){throw Error(stringFormat("Illegal function name '{0}'",[lt]))}if(ft.blockFunction){ut[lt]={tokenType:l.blockFunc,operation:ft.operation}}else{ut[lt]={tokenType:l.func,operation:ft.operation}}}}var ct={};if(e&&e.length){for(var at=0;at<e.length;at++){var ht=e[at];var lt=ht.name;if(lt){if(ct[lt]){throw Error(stringFormat("Duplicate variable name '{0}'",[lt]))}if(ut[lt]){throw Error(stringFormat("Variable name already used as function name '{0}'",[lt]))}if(!s.test(lt)||ot[lt]){throw Error(stringFormat("Illegal variable name '{0}'",[lt]))}ct[lt]={tokenType:l.variable,value:ht.value}}}}this.compile=function(e){function y(e,t){if(st[e][t]){return st[e][t]}if(e==c.start||e==c.incomplete){if(s.test(t)){if(ut[t]){return ut[t]}if(ct[t]){return ct[t]}}if(o.test(t)){if(!g[t]){g[t]={tokenType:l.variable,value:new f}}return g[t]}if(u.test(t)){return{tokenType:l.literal,value:Number(t)}}if(a.test(t)){return{tokenType:l.literal,value:t.substring(1,t.length-1).replace(/(\\")/g,'"')}}}throw new Error(stringFormat("Unexpected token '{0}'",[t]))}function b(e,t){var n=new dt;var r=c.incomplete;for(var i=t;i<e.length;i++){var s=y(r,e[i]);r=h[s.tokenType];n.addToken(s)}if(r!=c.complete){throw new Error("Unexpected end of statement")}return n.getExpression()}function w(e){try{var t=e.match(i);var n=t[0];switch(n){case"if":var r=new d(b(t,1));m.addLine(r);v.push(m);m=r;break;case"else":if(m.addCondition){if(t[1]=="if"){m.addCondition(b(t,2))}else{m.addCondition(null)}}else{throw new Error("Unexpected statement")}break;case"end":if(t.length>1){throw new Error("Unexpected tokens after 'end'")}if(v.length==0){throw new Error("Unexpected statement")}m=v.pop();break;default:var s=b(t,0);if(s.block){m.addLine(s.block);v.push(m);m=s.block}else{m.addLine(mt(b(t,0),e))}}}catch(o){throw new Error(stringFormat("Unable to parse statement '{0}':\n{1}",[e,o.message]))}}var t=new p;var v=[];var m=t;var g={};var E=e.match(n);for(var S=0;S<E.length;S++){var x=E[S];if(r.test(x)){w(x.substring(1,x.length-1))}else{m.addLine(vt(x.replace(/\[\[/g,"[").replace(/\]\]/g,"]")))}}return t}}function PageNumberVariable(e){this.isPageNumber=true;this.pageId=e}function StoryTeller(e,t){function f(e){var t;if(e){if(!(e in r.index)){throw new Error(stringFormat("Page not found: {0}",[pageIdentifier]))}t=r.index[e]}else{t=a}return new IntegerVariable(0,r.contents.length-1,a,false)}function h(e,t){var n=t.evaluate();var i=y.toBase64();if(typeof n=="number"){l.set(n)}else{if(!(n in r.index)){throw new Error(stringFormat("Page not found: {0}",[n]))}l.set(r.index[n])}var s=e.execute();var o=new StringBuilder;o.append('<a href="#');o.append(y.toBase64());o.append('">');o.append(s);o.append("</a>");y.fromBase64(i);return o.getValue()}function p(e){var t=e.execute();var n=new StringBuilder;n.append('<a href="#" onclick="window.location.hash = \'\';window.location.reload(true);">');n.append(t);n.append("</a>");return n.getValue()}function d(e){if(typeof e=="number"){var t=e}else{if(!(e in r.index)){throw new Error(stringFormat("Page not found: {0}",[e]))}var t=r.index[e]}try{var n=m.compile(r.contents[t].body);return n.execute()}catch(i){throw new Error(stringFormat("Error in subpage '{0}'\n{1}",[e,i.message]))}}function g(){var e=r.contents[l.get()];if(e&&e.body){try{var t=m.compile(e.body);n.innerHTML=t.execute()}catch(i){console.log(stringFormat("Error in page '{0}'\n{1}",[e.name,i.message]));n.innerHTML='<span class="error">An error has occurred.</span>'}}else{console.log(stringFormat("Error. Page number {0} does not exist.",[l.get()]));n.innerHTML='<span class="error">An error has occurred.</span>'}window.scroll(0,0)}var n=null;var r={contents:[],index:{}};var i=document.body.getElementsByTagName("*");var s=0;for(var o=0;o<i.length;o++){var u=i[o];switch(u.className){case"StoryTeller":if(n){throw new Error("Multiple 'StoryTeller' Divs")}n=u;break;case"page":if(r.index[u.id]){throw new Error(stringFormat("Duplicate page ID: {0}",[u.id]))}r.contents[s]={name:u.id,body:u.innerHTML};r.index[u.id]=s;s++;break}}if(!n){n=document.body}var a=0;if(r.contents.length<1){throw new Error("No pages found")}if(r.index["start"]){a=r.index["start"]}var l=f();var c=[l,random];if(e&&e.length){for(var o=0;o<e.length;o++){if(e[o].isPageNumberVariable){e[o]=f(e[o].pageId)}c.push(e[o].value)}}var v=[{name:"randomInteger",operation:random.getInteger.bind(random)},{name:"randomNumber",operation:random.getNumber.bind(random)},{name:"randomBoolean",operation:random.getBoolean.bind(random)},{name:"currentPage",operation:function(){return r.contents[l.get()].name}},{name:"currentPageNumber",operation:function(){return l.get()}},{name:"include",operation:d},{name:"link",operation:h,blockFunction:true},{name:"reset",operation:p,blockFunction:true}];if(t&&t.length){for(var o=0;o<t.length;o++){v.push(t[o])}}var m=new Compiler(e,v);var y=new State(c,g);g()}var random=new RandomNumberGenerator;var Base64=function(){function r(){function i(i,s){i=i<<r|n;s+=r;while(s>=6){t+=e.charAt(i&63);s-=6;i=i>>6}n=i;r=s}var t="";var n=0;var r=0;this.addInt16Array=function(e,t){for(var n=0;n<e.length;n++){var r=Math.min(t,16);i(e[n],r);t-=r}};this.chars=function(){if(r==0){return t}else{return t+e.charAt(n)}}}function i(e){function o(){return t[n.charAt(r++)]}function u(e){var t=i;var n=s;while(n<e){t=t|o()<<n;n+=6}s=n-e;i=t>>e;return t&(1<<e)-1}var n=e;var r=0;var i=0;var s=0;this.readInt16Array=function(e){var t=[];while(e>0){var n=Math.min(e,16);t.push(u(n));e-=n}return t}}var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_";var t={};for(var n=0;n<e.length;n++){t[e.charAt(n)]=n}return{Builder:r,Reader:i}}();var variables;var functions;window.onload=function(){var e=new StoryTeller(variables,functions)}