<html>
	<head>
		<title>StoryTeller</title>
		<style>
body { margin: 0; padding: 50px; background-color: #666666; ; color: #666666; }
h1 {margin: 0; padding: 0;}
.page {	display: none;}
.error {color: #FF0000;}
.header {  margin: 0; padding: 5px 10px 5px 10px; background-color: #000000 }
.StoryTeller { margin: 0; padding: 20px; background-color: #FFFFFF; border-style: solid; border-width: 1px; border-color: #000000; }
		</style>        
        <script type="text/javascript">
function StringBuilder(){var e=[];this.append=function(t){e.push(t)};this.getValue=function(){return e.join("")}}function stringFormat(e,t){return e.replace(/{(\d+)}/g,function(e,n){return t[n]})}function RandomNumberGenerator(){var e=new IntegerVariable(0,Math.pow(2,32)-1,Math.floor(Math.random()*Math.pow(2,32)),false);var t=1013904223;var n=Math.pow(2,32);var r=1664525;var i=Math.pow(2,52);this.getByte=function(){var i=e.get();i=(r*i+t)%n;e.set(i);return(i&1044480)>>12};this.getDouble=function(){var e=0;for(var t=0;t<6;t++){e*=256;e+=this.getByte()}e*=16;e+=this.getByte()>>4;return e/i};this.getBoolean=function(e){return this.getDouble()<e};this.getNumber=function(e,t){return this.getDouble()*(t-e)+e};this.getInteger=function(e,t){return Math.floor(this.getNumber(e,t))};this.size=function(){return e.size()};this.toInt16Array=function(){return e.toInt16Array()};this.fromInt16Array=function(t){e.fromInt16Array(t)}}function State(e,t){function i(e){var t=new Base64.Reader(e);for(var r=0;r<n.length;r++){var i=n[r];var s=t.readInt16Array(i.size());i.fromInt16Array(s)}}function s(){return window.location.hash.replace(/^#/,"")}function u(){var e=s();if(e!=o){o=e;i(o);r()}}var n=e;var r=t;this.toBase64=function(){var e=new Base64.Builder;for(var t=0;t<n.length;t++){var r=n[t];e.addInt16Array(r.toInt16Array(),r.size())}return e.chars()};this.fromBase64=i;var o=s();if(o.length==0){o=this.toBase64();window.location.hash=o}else{i(o)}var a=window.setInterval(u,100)}function BooleanVariable(e){var t=Boolean(e);this.set=function(e){t=Boolean(e)};this.get=function(){return t};this.size=function(){return 1};this.toInt16Array=function(){if(t){return[1]}else{return[0]}};this.fromInt16Array=function(e){t=(e[0]&1)==1}}function IntegerVariable(e,t,n,r){function f(n){n=Math.floor(n);if(isNaN(n)){n=0}if(n<e){if(r){n=((n-i)%u+u)%u+e}else{n=i}}if(n>t){if(r){n=(n-i)%u+e}else{n=s}}return n}if(t<e){throw new Error("max cannot be less than min")}var i=e;var s=t;var o=r;var u=t-e+1;var a=Math.ceil(Math.log(u)/Math.log(2));var l=f(n);this.set=function(e){l=f(e)};this.get=function(){return l};this.size=function(){return a};this.toInt16Array=function(){var e=[];var t=Math.ceil(a/16);var n=l-i;for(var r=0;r<t;r++){e[r]=n%65536;n=Math.floor(n/65536)}return e};this.fromInt16Array=function(e){var t=0;for(var n=e.length-1;n>=0;n--){t*=65536;t+=e[n]}l=f(t+i)}}function NumberVariable(e){function n(e){if(e==Number.POSITIVE_INFINITY){return{sign:0,biasedExponent:2047,mantissa:0}}if(e==Number.NEGATIVE_INFINITY){return{sign:1,biasedExponent:2047,mantissa:0}}if(isNaN(e)){return{sign:1,biasedExponent:2047,mantissa:0xfffffffffffff}}if(e==0){return{sign:0,biasedExponent:0,mantissa:0}}var t={};t.sign=e<0?1:0;var n=Math.abs(e);var r=Math.floor(Math.log(n)/Math.log(2));t.biasedExponent=r+1023;if(t.biasedExponent==0){var i=Math.pow(2,-1022);t.mantissa=n/i*4503599627370496}else{var i=Math.pow(2,r);var s=n/i;t.mantissa=(s-1)*4503599627370496}return t}function r(e){if(e.biasedExponent==2047){if(e.mantissa==0){if(e.sign==0){return Number.POSITIVE_INFINITY}else{return Number.NEGATIVE_INFINITY}}else{return NaN}}var t;var n;if(e.biasedExponent==0){t=e.mantissa/4503599627370496;n=Math.pow(2,-1022)}else{t=1+e.mantissa/4503599627370496;var r=e.biasedExponent-1023;n=Math.pow(2,r)}var i=t*n;return e.sign==1?-i:i}var t=Number(e);this.set=function(e){t=Number(e)};this.get=function(){return t};this.size=function(){return 64};this.toInt16Array=function(){var e=n(t);var r=e.mantissa;var i=[];for(var s=0;s<3;s++){i[s]=r%65536;r=Math.floor(r/65536)}i[3]=e.sign<<15|e.biasedExponent<<4|r;return i};this.fromInt16Array=function(e){var n={};var i=e[3]&15;for(var s=2;s>=0;s--){i*=65536;i+=e[s]}n.mantissa=i;n.biasedExponent=e[3]>>4&2047;n.sign=e[3]>>15;t=r(n)}}function Compiler(e,t){function n(){var e;this.get=function(){return e};this.set=function(t){e=t}}function s(e){return{tokenType:r.literal,value:e}}function u(){var e=[];this.addLine=function(t){e.push(t)};this.execute=function(t){for(var n=0;n<e.length;n++){var r=e[n];try{r.execute(t)}catch(i){if(r.source){throw new Error(stringFormat("Unable to execute statement '{0}':\n{1}",[r.source,i.message]))}}}}}function a(e){function r(e){n={condition:e,block:new u};t.push(n)}var t=[];var n;r(e);this.addCondition=function(e){if(n.condition==null){throw new Error("Unreachable 'else' clause")}r(e)};this.addLine=function(e){n.block.addLine(e)};this.execute=function(e){for(var n=0;n<t.length;n++){var r=t[n];if(r.condition==null||r.condition.evaluate().value){r.block.execute(e);return}}}}function f(e,t){var n=new u;var r=[n];for(var i=0;i<t.length;i++){var s=t[i];r.push({evaluate:function(){return s.evaluate().value},assign:s.assign.bind(s)})}this.addLine=function(e){n.addLine(e)};this.execute=function(t){t.append(e.apply(null,r))}}function l(e){throw new Error("Expression cannot be assigned to")}function c(e){return{value:e,output:true}}function h(e){return{value:e,output:false}}function p(e){return{evaluate:function(){return c(e)},assign:function(e){throw new Error("Attempt to assign to literal")}}}function d(e){return{evaluate:function(){return c(e.get())},assign:function(t){e.set(t);return h(e.get())}}}function v(e,t){return{evaluate:function(){return e.assign(t.evaluate().value)},assign:l}}function m(e,t){return{evaluate:function(){return c(e.evaluate().value==t.evaluate().value)},assign:l}}function g(e,t){return{evaluate:function(){return c(e.evaluate().value+t.evaluate().value)},assign:l}}function y(e,t){return{evaluate:function(){return c(e.evaluate().value-t.evaluate().value)},assign:l}}function b(e,t){return{evaluate:function(){return c(e.evaluate().value*t.evaluate().value)},assign:l}}function w(e,t){return{evaluate:function(){return c(e.evaluate().value/t.evaluate().value)},assign:l}}function E(e,t){return{evaluate:function(){return c(e.evaluate().value%t.evaluate().value)},assign:l}}function S(e){return{evaluate:function(){return c(!e.evaluate().value)},assign:l}}function x(e){return{evaluate:function(){return c(-e.evaluate().value)},assign:l}}function T(e,t){return{evaluate:function(){evaluatedParameters=[];for(var n=0;n<t.length;n++){evaluatedParameters.push(t[n].evaluate().value)}return c(e.apply(null,evaluatedParameters))},assign:l}}function N(e,t){return{block:new f(e,t),evaluate:function(){throw new Error("Block functions cannot be evaluated in a statement.")},assign:l}}function X(){var e=[];this.addToken=function(t){switch(t.tokenType){case r.operator:var n=e.pop();var i=e.pop();e.push(t.expression(i,n));break;case r.unaryOperator:var s=e.pop();e.push(t.expression(s));break;case r.func:var o=[];var u;while(u=e.pop()){o.push(u)}e.push(T(t.operation,o.reverse()));break;case r.blockFunc:var o=[];var u;while(u=e.pop()){o.push(u)}e.push(N(t.operation,o.reverse()));break;case r.literal:e.push(p(t.value));break;case r.variable:e.push(d(t.value));break;case r.marker:e.push(null)}};this.getExpression=function(){if(e.length==0){throw new Error("Empty expression")}if(e.length>1){throw new Error("Incomplete expression")}return e.pop()}}function V(){function n(t){if(e.length==0)return false;var n=e[e.length-1].tokenType;for(var r=0;r<t.length;r++){if(n==t[r])return true}return false}function i(t){if(e.length==0)return false;var n=e[e.length-1];return n.tokenType==r.unaryOperator||n.tokenType==r.operator&&n.precedence>=t}var e=[];var t=new X;this.addToken=function(s){switch(s.tokenType){case r.leftBracket:e.push(s);break;case r.rightBracket:while(!n([r.leftBracket])){t.addToken(e.pop())}e.pop();if(n([r.func,r.blockFunc])){t.addToken(e.pop())}break;case r.separator:while(!n([r.leftBracket])){t.addToken(e.pop())}break;case r.operator:while(i(s.precedence)){t.addToken(e.pop())}e.push(s);break;case r.unaryOperator:e.push(s);break;case r.func:case r.blockFunc:e.push(s);t.addToken(C);break;default:t.addToken(s)}};this.getExpression=function(){while(e.length>0){t.addToken(e.pop())}return t.getExpression()}}function et(e){return{execute:function(t){t.append(e)}}}function tt(e,t){return{execute:function(t){var n=e.evaluate();if(n.output){t.append(n.value)}},source:t}}var r={leftBracket:1,rightBracket:2,separator:5,func:6,blockFunc:7,operator:8,unaryOperator:9,variable:10,literal:11,marker:12};var i={incomplete:1,complete:2,func:3};var o=[];o[r.leftBracket]=i.start;o[r.rightBracket]=i.complete;o[r.separator]=i.start;o[r.func]=i.func;o[r.operator]=i.incomplete;o[r.unaryOperator]=i.incomplete;o[r.variable]=i.complete;o[r.literal]=i.complete;var C={tokenType:r.marker};var k={tokenType:r.leftBracket};var L={tokenType:r.rightBracket};var A={tokenType:r.separator};var O={tokenType:r.operator,precedence:0,expression:v};var M={tokenType:r.operator,precedence:1,expression:m};var _={tokenType:r.operator,precedence:2,expression:g};var D={tokenType:r.operator,precedence:2,expression:y};var P={tokenType:r.operator,precedence:3,expression:b};var H={tokenType:r.operator,precedence:3,expression:w};var B={tokenType:r.operator,precedence:3,expression:E};var j={tokenType:r.unaryOperator,expression:S};var F={tokenType:r.unaryOperator,expression:x};var I=[];I[i.start]={"(":k,"-":F,not:j};I[i.complete]={")":L,",":A,"=":O,equal:M,"+":_,"-":D,"*":P,"/":H,"%":B};I[i.incomplete]=I[i.start];I[i.func]={"(":k};var q={};for(var R=0;R<e.length;R++){var U=e[R];q[U.name]={tokenType:r.variable,value:U.value}}var z={};for(var R=0;R<t.length;R++){var W=t[R];if(W.blockFunction){z[W.name]={tokenType:r.blockFunc,operation:W.operation}}else{z[W.name]={tokenType:r.func,operation:W.operation}}}var $=/((\[\[)|([^[]))+|(\[(("(([\\]")|[^"])*")|([^\]]))*\])/g;var J=/^\[(("((\\")|[^"])*")|([^\]]))*\]$/;var K=/[^\$_a-zA-Z0-9\s"]|([0-9]*\.[0-9]+)|([0-9]+)|(\$[_a-zA-Z0-9]+)|([_a-zA-Z][_a-zA-Z0-9]*)|("((\\")|[^"])*")/g;var Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;var G=/^\$[_a-zA-Z0-9]+$/;var Y=/^([0-9]*\.[0-9])|([0-9]+)$/;var Z=/^"((\\")|[^"])*"$/;this.compile=function(e){function c(e,t){if(I[e][t]){return I[e][t]}if(e==i.start||e==i.incomplete){if(Q.test(t)){if(z[t]){return z[t]}if(q[t]){return q[t]}}if(G.test(t)){if(!l[t]){l[t]={tokenType:r.variable,value:new n}}return l[t]}if(Y.test(t)){return{tokenType:r.literal,value:Number(t)}}if(Z.test(t)){return{tokenType:r.literal,value:t.substring(1,t.length-1).replace(/(\\")/g,'"')}}}throw new Error(stringFormat("Unexpected token '{0}'",[t]))}function h(e,t){var n=new V;var r=i.incomplete;for(var s=t;s<e.length;s++){var u=c(r,e[s]);r=o[u.tokenType];n.addToken(u)}if(r!=i.complete){throw new Error("Unexpected end of statement")}return n.getExpression()}function p(e){try{var t=e.match(K);var n=t[0];switch(n){case"if":var r=new a(h(t,1));f.addLine(r);s.push(f);f=r;break;case"else":if(f.addCondition){if(t[1]=="if"){f.addCondition(h(t,2))}else{f.addCondition(null)}}else{throw new Error("Unexpected statement")}break;case"end":if(t.length>1){throw new Error("Unexpected tokens after 'end'")}if(s.length==0){throw new Error("Unexpected statement")}f=s.pop();break;default:var i=h(t,0);if(i.block){f.addLine(i.block);s.push(f);f=i.block}else{f.addLine(tt(h(t,0),e))}}}catch(o){throw new Error(stringFormat("Unable to parse statement '{0}':\n{1}",[e,o.message]))}}var t=new u;var s=[];var f=t;var l={};var d=e.match($);for(var v=0;v<d.length;v++){var m=d[v];if(J.test(m)){p(m.substring(1,m.length-1))}else{f.addLine(et(m.replace(/\[\[/g,"[").replace(/\]\]/g,"]")))}}return t}}function StoryTeller(e){function l(e,t){var r=t.evaluate();if(!(r in n.index)){throw new Error(stringFormat("Page not found: {0}",[r]))}var i=v.toBase64();a.set(n.index[r]);var s=new StringBuilder;e.execute(s);var o=new StringBuilder;o.append('<a href="#');o.append(v.toBase64());o.append('">');o.append(s.getValue());o.append("</a>");v.fromBase64(i);return o.getValue()}function c(e){if(!(e in n.index)){throw new Error(stringFormat("Page not found: {0}",[e]))}var t=n.index[e];try{var r=p.compile(n.contents[t].body);var i=new StringBuilder;r.execute(i);return i.getValue()}catch(s){throw new Error(stringFormat("Error in subpage '{0}'\n{1}",[e,s.message]))}}function d(){try{var e=p.compile(n.contents[a.get()].body);var r=new StringBuilder;e.execute(r);t.innerHTML=r.getValue()}catch(i){console.log(stringFormat("Error in page '{0}'\n{1}",[n.contents[a.get()].name,i.message]));t.innerHTML='<span class="error">An error has occurred.</span>'}}var t=null;var n={contents:[],index:{}};var r=document.body.getElementsByTagName("*");var i=0;for(var s=0;s<r.length;s++){var o=r[s];switch(o.className){case"StoryTeller":if(t){throw new Error("Multiple 'StoryTeller' Divs")}t=o;break;case"page":if(n.index[o.id]){throw new Error(stringFormat("Duplicate page ID: {0}",[o.id]))}n.contents[i]={name:o.id,body:o.innerHTML};n.index[o.id]=i;i++;break}}if(!t){t=document.body}var u=0;if(n.contents.length<1){throw new Error("No pages found")}if(n.index["start"]){u=pages.index["start"]}var a=new IntegerVariable(0,n.contents.length-1,u,false);var f=[a,random];if(e){for(var s=0;s<e.length;s++){f.push(e[s].value)}}var h=[{name:"randomInteger",operation:random.getInteger.bind(random)},{name:"randomNumber",operation:random.getNumber.bind(random)},{name:"randomBoolean",operation:random.getBoolean.bind(random)},{name:"include",operation:c},{name:"link",operation:l,blockFunction:true}];var p=new Compiler(e,h);var v=new State(f,d);d()}var random=new RandomNumberGenerator;var Base64=function(){function r(){function i(i,s){i=i<<r|n;s+=r;while(s>=6){t+=e.charAt(i&63);s-=6;i=i>>6}n=i;r=s}var t="";var n=0;var r=0;this.addInt16Array=function(e,t){for(var n=0;n<e.length;n++){var r=Math.min(t,16);i(e[n],r);t-=r}};this.chars=function(){if(r==0){return t}else{return t+e.charAt(n)}}}function i(e){function o(){return t[n.charAt(r++)]}function u(e){var t=i;var n=s;while(n<e){t=t|o()<<n;n+=6}s=n-e;i=t>>e;return t&(1<<e)-1}var n=e;var r=0;var i=0;var s=0;this.readInt16Array=function(e){var t=[];while(e>0){var n=Math.min(e,16);t.push(u(n));e-=n}return t}}var e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_";var t={};for(var n=0;n<e.length;n++){t[e.charAt(n)]=n}return{Builder:r,Reader:i}}();window.onload=function(){var e=new StoryTeller(variables)}		
		</script>
		<script type="text/javascript"> 	        
var variables = [
    { name : "skillPoints", value : new IntegerVariable(0, 20, 20, false) },
    { name : "earth", value : new IntegerVariable(0, 20, 0, false) },
    { name : "fire", value : new IntegerVariable(0, 20, 0, false) },
    { name : "air", value : new IntegerVariable(0, 20, 0, false) },
    { name : "water", value : new IntegerVariable(0, 20, 0, false) }
];
		</script>
	</head>
	<body>    
        <div class="header">
            <h1>StoryTeller</h1>
        </div>
        <div class="StoryTeller">
            <div id="start" class="page">
                <h2>Contents</h2>
                <ol>
                    <li>[link("whatIsStoryTeller")]What is StoryTeller[end]</li>
                </ol>
            </div>
            <div id="whatIsStoryTeller" class="page">
                <h2>What is StoryTeller</h2>
                
                [include("footer")]
            </div>
            <div id="footer" class="page">
                <hr/>
                [link("start")]Back to Contents[end]
            </div>
        </div>
	</body>
</html>